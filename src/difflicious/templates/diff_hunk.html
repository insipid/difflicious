<!-- Single Hunk -->
<div class="hunk border-b border-neutral-100 last:border-b-0" data-line-start="{{ hunk.line_start }}"
    data-line-end="{{ hunk.line_end }}" data-left-line-start="{{ hunk.left_start or 0 }}"
    data-left-line-end="{{ hunk.left_end or 0 }}">

    <!-- Up Expansion Controls (before hunk) -->
    {% if hunk.can_expand_before %}
    <div class="hunk-expansion bg-blue-50 text-xs font-mono text-blue-800 border-b border-blue-100 flex">
        <!-- Left Side Controls -->
        <div class="flex-1 border-r border-blue-200">
            <div class="flex">
                <div class="w-12 bg-blue-100 border-r border-blue-200 select-none flex flex-col">
                    <button onclick="expandContext(this, '{{ file.path }}', {{ hunk.index }}, 'before', 10, 'pygments')"
                        class="expansion-btn w-full px-2 py-1 text-xs bg-blue-200 hover:bg-blue-300 text-blue-800 transition-colors flex items-center justify-center h-full"
                        data-target-start="{{ hunk.expand_before_start }}"
                        data-target-end="{{ hunk.expand_before_end }}" data-direction="before"
                        title="Expand 10 lines up ({{ hunk.expand_before_start }}-{{ hunk.expand_before_end }})">
                        ▲
                    </button>
                </div>
                <div class="flex-1 px-2 py-2 overflow-hidden whitespace-nowrap flex items-center min-h-[2rem]">
                    {% if hunk.section_header %}
                    <span>{{ hunk.section_header }}</span>
                    {% else %}
                    <span class="text-transparent">&nbsp;</span>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Right Side Controls -->
        <div class="flex-1">
            <div class="flex">
                <div class="w-12 bg-blue-100 border-r border-blue-200 select-none flex flex-col">
                    <button onclick="expandContext(this, '{{ file.path }}', {{ hunk.index }}, 'before', 10, 'pygments')"
                        class="expansion-btn w-full px-2 py-1 text-xs bg-blue-200 hover:bg-blue-300 text-blue-800 transition-colors flex items-center justify-center h-full"
                        data-target-start="{{ hunk.expand_before_start }}"
                        data-target-end="{{ hunk.expand_before_end }}" data-direction="before"
                        title="Expand 10 lines up ({{ hunk.expand_before_start }}-{{ hunk.expand_before_end }})">
                        ▲
                    </button>
                </div>
                <div class="flex-1 px-2 py-2 overflow-hidden min-h-[2rem] flex items-center">
                    <span class="text-transparent">&nbsp;</span>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Hunk Lines -->
    <div class="hunk-lines font-mono text-xs" data-left-start-line="{{ hunk.old_start }}"
        data-left-end-line="{{ hunk.old_start + hunk.old_count - 1 }}" data-right-start-line="{{ hunk.new_start }}"
        data-right-end-line="{{ hunk.new_start + hunk.new_count - 1 }}">
        {% for line in hunk.lines %}
        <div class="diff-line flex line-{{ line.type }}">
            <!-- Left Side (Before) -->
            <div
                class="line-left flex-1 border-r border-neutral-200 dark:border-neutral-600 {% if line.left and line.left.type == 'deletion' %}bg-red-50 dark:bg-red-900/20{% elif line.type == 'context' %}bg-neutral-50 dark:bg-neutral-800{% else %}bg-white dark:bg-neutral-800{% endif %}">
                <div class="flex">
                    <div
                        class="line-num w-12 px-2 py-1 text-neutral-400 text-right bg-neutral-50 dark:bg-neutral-700 border-r border-neutral-200 dark:border-neutral-600 select-none">
                        {% if line.left and line.left.line_num %}
                        <span>{{ line.left.line_num }}</span>
                        {% endif %}
                    </div>
                    <div class="line-content flex-1 px-2 py-1 overflow-x-auto">
                        {% if line.left and line.left.type == 'deletion' %}
                        <span class="text-red-600">-</span>
                        {% elif line.type == 'context' %}
                        <span class="text-neutral-400">&nbsp;</span>
                        {% endif %}
                        {% if line.left and (line.left.highlighted_content or line.left.content) %}
                        {% if line.left.highlighted_content %}
                        <span>{{ line.left.highlighted_content|safe }}</span>
                        {% elif line.left.content %}
                        <span>{{ line.left.content }}</span>
                        {% endif %}
                        {% if line.left.missing_newline %}
                        <span class="no-newline-indicator text-red-500" aria-label="No newline at end of file">↩</span>
                        {% endif %}
                        {% else %}
                        <!-- Ensure empty content areas still take up space -->
                        <span>&nbsp;</span>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Right Side (After) -->
            <div
                class="line-right flex-1 {% if line.right and line.right.type == 'addition' %}bg-green-50 dark:bg-green-900/20{% elif line.type == 'context' %}bg-neutral-50 dark:bg-neutral-800{% else %}bg-white dark:bg-neutral-800{% endif %}">
                <div class="flex">
                    <div
                        class="line-num w-12 px-2 py-1 text-neutral-400 text-right bg-neutral-50 dark:bg-neutral-700 border-r border-neutral-200 dark:border-neutral-600 select-none">
                        {% if line.right and line.right.line_num %}
                        <span>{{ line.right.line_num }}</span>
                        {% endif %}
                    </div>
                    <div class="line-content flex-1 px-2 py-1 overflow-x-auto">
                        {% if line.right and line.right.type == 'addition' %}
                        <span class="text-green-600">+</span>
                        {% elif line.type == 'context' %}
                        <span class="text-neutral-400">&nbsp;</span>
                        {% endif %}
                        {% if line.right and (line.right.highlighted_content or line.right.content) %}
                        {% if line.right.highlighted_content %}
                        <span>{{ line.right.highlighted_content|safe }}</span>
                        {% elif line.right.content %}
                        <span>{{ line.right.content }}</span>
                        {% endif %}
                        {% if line.right.missing_newline %}
                        <span class="no-newline-indicator text-red-500" aria-label="No newline at end of file">↩</span>
                        {% endif %}
                        {% else %}
                        <!-- Ensure empty content areas still take up space -->
                        <span>&nbsp;</span>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Down Expansion Controls (after hunk) -->
    {% if hunk.can_expand_after %}
    <div class="hunk-expansion bg-blue-50 text-xs font-mono text-blue-800 border-t border-blue-100 flex">
        <!-- Left Side Controls -->
        <div class="flex-1 border-r border-blue-200">
            <div class="flex">
                <div class="w-12 bg-blue-100 border-r border-blue-200 select-none flex flex-col">
                    <button onclick="expandContext(this, '{{ file.path }}', {{ hunk.index }}, 'after', 10, 'pygments')"
                        class="expansion-btn w-full px-2 py-1 text-xs bg-blue-200 hover:bg-blue-300 text-blue-800 transition-colors flex items-center justify-center h-full"
                        data-target-start="{{ hunk.expand_after_start }}" data-target-end="{{ hunk.expand_after_end }}"
                        data-direction="after"
                        title="Expand 10 lines down ({{ hunk.expand_after_start }}-{{ hunk.expand_after_end }})">
                        ▼
                    </button>
                </div>
                <div class="flex-1 px-2 py-2 overflow-hidden whitespace-nowrap flex items-center min-h-[2rem]">
                    <span class="text-transparent">&nbsp;</span>
                </div>
            </div>
        </div>

        <!-- Right Side Controls -->
        <div class="flex-1">
            <div class="flex">
                <div class="w-12 bg-blue-100 border-r border-blue-200 select-none flex flex-col">
                    <button onclick="expandContext(this, '{{ file.path }}', {{ hunk.index }}, 'after', 10, 'pygments')"
                        class="expansion-btn w-full px-2 py-1 text-xs bg-blue-200 hover:bg-blue-300 text-blue-800 transition-colors flex items-center justify-center h-full"
                        data-target-start="{{ hunk.expand_after_start }}" data-target-end="{{ hunk.expand_after_end }}"
                        data-direction="after"
                        title="Expand 10 lines down ({{ hunk.expand_after_start }}-{{ hunk.expand_after_end }})">
                        ▼
                    </button>
                </div>
                <div class="flex-1 px-2 py-2 overflow-hidden min-h-[2rem] flex items-center">
                    <span class="text-transparent">&nbsp;</span>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
