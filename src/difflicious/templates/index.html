{% extends "base.html" %}

{% block content %}
<!-- Toolbar -->
<header class="bg-white border-b border-gray-200 px-4 py-3">
    <div class="flex items-center justify-between">
        <div class="flex items-center space-x-4">
            <h1 class="text-xl font-semibold text-gray-900">Difflicious</h1>

            <!-- Base Branch Dropdown -->
            <form method="GET" action="/" class="flex items-center space-x-2">
                <label class="text-sm font-medium text-gray-700">Base:</label>
                <select name="base_branch" onchange="this.form.submit()"
                    class="bg-white border border-gray-300 rounded-md px-3 py-1.5 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    {% for branch in branches.all %}
                    <option value="{{ branch }}" {% if branch == current_base_branch %}selected{% endif %}>
                        {{ branch }}
                    </option>
                    {% endfor %}
                </select>

                <!-- Diff Options -->
                <div class="flex items-center space-x-4">
                    <label class="flex items-center">
                        <input type="checkbox" name="unstaged" value="true" 
                               {% if unstaged %}checked{% endif %}
                               onchange="this.form.submit()"
                               class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                        <span class="ml-1 text-sm text-gray-700">Unstaged</span>
                    </label>
                    
                    <label class="flex items-center">
                        <input type="checkbox" name="untracked" value="true"
                               {% if untracked %}checked{% endif %}
                               onchange="this.form.submit()"
                               class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                        <span class="ml-1 text-sm text-gray-700">Untracked</span>
                    </label>
                </div>
                
                <!-- Search Filter -->
                <input type="text" name="search" value="{{ search_filter or '' }}" 
                       placeholder="Search files..." 
                       class="border border-gray-300 rounded-md px-3 py-1.5 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            </form>
        </div>

        <!-- Status -->
        <div class="flex items-center space-x-4">
            <div class="text-sm text-gray-600">
                {{ total_files }} files changed
            </div>
            <button onclick="location.reload()" 
                class="bg-blue-600 text-white px-3 py-1.5 rounded-md text-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                Refresh
            </button>
        </div>
    </div>
</header>

<!-- Main Content -->
<main class="flex-1 overflow-hidden">
    {% if loading %}
    <!-- Loading State -->
    <div class="flex items-center justify-center h-full">
        <div class="text-center">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"></div>
            <p class="mt-2 text-gray-600">Loading git diff data...</p>
        </div>
    </div>
    {% elif not groups or not total_files %}
    <!-- Empty State -->
    <div class="flex items-center justify-center h-full">
        <div class="text-center">
            <div class="text-6xl mb-4">âœ¨</div>
            <h2 class="text-xl font-semibold text-gray-900 mb-2">No changes found</h2>
            <div class="text-gray-600 space-y-2">
                {% if not unstaged and not untracked %}
                <p>Enable "Unstaged" or "Untracked" to see changes.</p>
                {% elif unstaged and not untracked %}
                <p>No unstaged changes in your working directory.</p>
                {% elif not unstaged and untracked %}
                <p>No untracked files found.</p>
                {% else %}
                <p>Your working directory is clean - no unstaged or untracked files.</p>
                {% endif %}
                {% if current_base_branch != 'main' %}
                <p class="text-sm text-gray-500 mt-3">
                    Comparing against branch: <span class="font-mono">{{ current_base_branch }}</span>
                </p>
                {% endif %}
            </div>
        </div>
    </div>
    {% else %}
    <!-- Diff Content -->
    <div class="h-full overflow-y-auto">
        <div class="p-4 space-y-6">
            <!-- Global Controls -->
            <div class="flex items-center space-x-2 mb-4">
                <button onclick="expandAllFiles()" 
                    class="bg-gray-100 text-gray-700 hover:bg-gray-200 px-3 py-1.5 rounded text-sm focus:outline-none focus:ring-2 focus:ring-gray-400 transition-colors">
                    Expand All
                </button>
                <button onclick="collapseAllFiles()"
                    class="bg-gray-100 text-gray-700 hover:bg-gray-200 px-3 py-1.5 rounded text-sm focus:outline-none focus:ring-2 focus:ring-gray-400 transition-colors">
                    Collapse All  
                </button>
            </div>

            <!-- Render Diff Groups -->
            {% include "diff_groups.html" %}
        </div>
    </div>
    {% endif %}
</main>
{% endblock %}