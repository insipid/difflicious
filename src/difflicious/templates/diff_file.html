<!-- Single File Diff -->
{% set file_id = group_name + ":" + file.path %}
<div class="file-diff bg-neutral-50 dark:bg-neutral-800 border border-neutral-200 dark:border-neutral-600 rounded-lg shadow-sm"
    data-file="{{ file_id }}"
    {% if file.old_path %}data-old-path="{{ file.old_path }}"{% endif %}
    x-data="fileComponent('{{ file_id }}')"
    {% if file.hidden_by_search %}style="display: none;"{% endif %}>
    <!-- File Header Wrapper -->
    <div class="file-header-wrapper">
        <!-- Spacer div to fill the gap -->
        <div class="file-header-spacer"></div>
        <!-- File Header -->
        <div class="file-header flex items-center justify-between p-4 cursor-pointer hover:bg-neutral-50 dark:hover:bg-neutral-700 transition-colors space-x-2"
            @click="toggle()">
            <!-- Left side: toggle, expand, filename, status - all flush left -->
            <div class="flex items-center space-x-3 flex-shrink min-w-0">
                <span
                    class="toggle-icon text-neutral-400 dark:text-neutral-600 transition-transform duration-200 flex-shrink-0"
                    x-text="toggleIcon">
                </span>
                <span
                    class="expand-icon text-neutral-400 dark:text-neutral-600 hover:text-neutral-600 dark:hover:text-neutral-500 cursor-pointer transition-colors flex-shrink-0"
                    onclick="loadFullDiff('{{ file.path }}', '{{ file_id }}'); event.stopPropagation()"
                    title="Show complete file diff with unlimited context" id="expand-icon-{{ file_id }}">
                    â†•
                </span>
                <div class="flex-1 min-w-0 break-words">
                    <span class="font-mono text-sm text-neutral-900 dark:text-neutral-300" title="{{ file.path }}">
                        {%- if file.status == 'renamed' and file.old_path -%}
                        {{ file.old_path }} â†’ {{ file.path }}
                        {%- else -%}
                        {{ file.path }}
                        {%- endif -%}
                    </span>
                </div>

                <!-- Status label positioned on the right when filename wraps -->
                <div class="flex items-center ml-4">
                    <span class="status-badge
                    {%- if file.status == 'added' %} status-badge-added
                    {%- elif file.status == 'deleted' %} status-badge-deleted
                    {%- elif file.status == 'renamed' %} status-badge-renamed
                    {%- else %} status-badge-modified
                    {%- endif %}">
                        {%- if file.status == 'renamed' %}moved{%- else %}{{ file.status }}{%- endif %}
                    </span>
                </div>
            </div>

            <!-- Right side: diff counts and navigation -->
            <div class="flex items-center space-x-2 text-xs flex-shrink-0 ml-6">
                <!-- File Stats -->
                {% if file.additions > 0 %}
                <span class="file-stat file-stat-addition">
                    +{{ file.additions }}
                </span>
                {% endif %}
                {% if file.deletions > 0 %}
                <span class="file-stat file-stat-deletion">
                    -{{ file.deletions }}
                </span>
                {% endif %}

                <!-- File Navigation -->
                <div class="flex items-center space-x-1" onclick="event.stopPropagation()">
                    <button onclick="navigateToPreviousFile('{{ file_id }}')"
                        class="p-1 text-neutral-400 dark:text-neutral-600 hover:text-neutral-600 dark:hover:text-neutral-500 hover:bg-neutral-100 dark:hover:bg-neutral-700 rounded transition-colors"
                        title="Previous file">
                        <span class="text-sm">â†‘</span>
                    </button>
                    <button onclick="navigateToNextFile('{{ file_id }}')"
                        class="p-1 text-neutral-400 dark:text-neutral-600 hover:text-neutral-600 dark:hover:text-neutral-500 hover:bg-neutral-100 dark:hover:bg-neutral-700 rounded transition-colors"
                        title="Next file">
                        <span class="text-sm">â†“</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- File Content -->
    <div class="file-content" data-file-content="{{ file_id }}"
        x-show="isExpanded"
        x-cloak
        x-transition:enter="transition ease-out duration-200"
        x-transition:enter-start="opacity-0 scale-95"
        x-transition:enter-end="opacity-100 scale-100"
        x-transition:leave="transition ease-in duration-150"
        x-transition:leave-start="opacity-100 scale-100"
        x-transition:leave-end="opacity-0 scale-95">
        {% if file.status == 'renamed' and file.deletions == 0 %}
        <!-- Pure rename/move with no content changes - show expander bar -->
        <!-- Condition: renamed file with no deletions means all lines show as "additions" but it's actually unchanged content -->
        <div class="moved-file-content" data-file-path="{{ file.path }}" data-old-path="{{ file.old_path }}">
            <div class="moved-file-expansion bg-info-bg-50 text-xs font-mono text-info-text-800 flex">
                <!-- Left Side -->
                <div class="flex-1 border-r border-neutral-200 dark:border-neutral-600">
                    <div class="flex">
                        <div class="w-12 bg-info-bg-100 border-r border-neutral-200 dark:border-neutral-600 select-none flex flex-col">
                            <button onclick="loadMovedFileContent(this)"
                                class="expansion-btn w-full px-2 py-1 text-xs bg-info-bg-200 hover:bg-info-bg-300 text-info-text-800 transition-colors flex items-center justify-center h-full"
                                title="Show file content">
                                â†•
                            </button>
                        </div>
                        <div class="flex-1 px-2 py-2 overflow-hidden flex items-center min-h-[2rem] min-w-0">
                            <span class="truncate block">File moved (no changes) â€” click to view content</span>
                        </div>
                    </div>
                </div>
                <!-- Right Side -->
                <div class="flex-1">
                    <div class="flex">
                        <div class="w-12 bg-info-bg-100 border-r border-neutral-200 dark:border-neutral-600 select-none flex flex-col">
                            <button onclick="loadMovedFileContent(this)"
                                class="expansion-btn w-full px-2 py-1 text-xs bg-info-bg-200 hover:bg-info-bg-300 text-info-text-800 transition-colors flex items-center justify-center h-full"
                                title="Show file content">
                                â†•
                            </button>
                        </div>
                        <div class="flex-1 px-2 py-2 overflow-hidden flex items-center min-h-[2rem] min-w-0">
                            <span class="text-transparent">&nbsp;</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% elif not file.hunks or file.hunks|length == 0 %}
        <!-- No content available -->
        <div class="p-8 text-center text-neutral-500 dark:text-neutral-400">
            <div class="text-4xl mb-2">ðŸ“„</div>
            <p>No diff content available</p>
            <p class="text-sm">(Binary file, untracked, or no changes)</p>
        </div>
        {% elif file.is_full_file_deletion %}
        <!-- Special rendering for deleted files: full file on left, empty on right -->
        <div class="deleted-file-view font-mono text-xs">
            <div class="flex border-b border-neutral-200 dark:border-neutral-600 bg-neutral-100 dark:bg-neutral-700">
                <!-- Left header: Original file -->
                <div class="flex-1 px-4 py-2 text-neutral-600 dark:text-neutral-400 font-semibold border-r border-neutral-200 dark:border-neutral-600">
                    Original file ({{ file.deletions }} lines deleted)
                </div>
                <!-- Right header: Empty -->
                <div class="flex-1 px-4 py-2 text-neutral-600 dark:text-neutral-400 font-semibold">
                    File deleted
                </div>
            </div>
            <!-- Render all lines from the single hunk -->
            {% for hunk in file.hunks %}
            <div class="hunk-lines">
                {% for line in hunk.lines %}
                <div class="diff-line flex line-{{ line.type }}">
                    <!-- Left Side: All deleted lines -->
                    <div class="line-left flex-1 border-r border-neutral-200 dark:border-neutral-600">
                        <div class="flex">
                            <div class="line-num w-12 px-2 py-1 text-neutral-400 text-right border-r border-neutral-200 dark:border-neutral-600 select-none bg-red-50 dark:bg-red-900/20">
                                <span>{{ line.left.line_num }}</span>
                            </div>
                            <div class="line-content flex-1 px-2 py-1 overflow-x-auto bg-red-50 dark:bg-red-900/20">
                                <span class="text-danger-text-600">-</span>
                                {% if line.left.highlighted_content %}
                                <span>{{ line.left.highlighted_content|safe }}</span>
                                {% else %}
                                <span>{{ line.left.content }}</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <!-- Right Side: Empty -->
                    <div class="line-right flex-1 bg-neutral-50 dark:bg-neutral-800">
                        <div class="flex">
                            <div class="line-num w-12 px-2 py-1 text-neutral-400 text-right border-r border-neutral-200 dark:border-neutral-600 select-none">
                                &nbsp;
                            </div>
                            <div class="line-content flex-1 px-2 py-1">
                                <span>&nbsp;</span>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endfor %}
        </div>
        {% else %}
        <!-- Normal hunk rendering -->
        {% for hunk in file.hunks %}
        {% include "diff_hunk.html" with context %}
        {% endfor %}
        {% endif %}
    </div>
</div>
